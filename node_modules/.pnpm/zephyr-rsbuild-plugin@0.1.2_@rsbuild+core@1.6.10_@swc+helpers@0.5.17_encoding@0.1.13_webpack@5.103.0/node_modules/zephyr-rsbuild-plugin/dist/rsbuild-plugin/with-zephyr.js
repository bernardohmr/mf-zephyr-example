"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.withZephyr = withZephyr;
const zephyr_rspack_plugin_1 = require("zephyr-rspack-plugin");
function withZephyr(options) {
    return {
        name: 'zephyr-rsbuild-plugin',
        setup(api) {
            // Per Rspack team: @module-federation/rsbuild-plugin adds MF plugins in onBeforeCreateCompiler,
            // which runs AFTER modifyRspackConfig. So we must process the configs in onBeforeCreateCompiler
            // where the MF plugins are already present.
            // Using order: 'post' ensures we run after the MF plugin has set up the config.
            api.onBeforeCreateCompiler({
                order: 'post',
                handler: async ({ bundlerConfigs }) => {
                    // Process each bundler config (one per environment)
                    for (const config of bundlerConfigs) {
                        // Apply Zephyr's rspack transformation
                        // The real MF plugin is already present in the config and rspackWithZephyr will extract from it
                        const result = await (0, zephyr_rspack_plugin_1.withZephyr)(options)(config);
                        // Merge result back (rspackWithZephyr may return a new config or void)
                        if (result) {
                            Object.assign(config, result);
                        }
                    }
                },
            });
        },
    };
}
//# sourceMappingURL=with-zephyr.js.map