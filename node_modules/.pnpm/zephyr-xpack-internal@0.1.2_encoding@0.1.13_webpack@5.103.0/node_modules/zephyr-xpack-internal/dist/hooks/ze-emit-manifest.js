"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.setupManifestEmission = setupManifestEmission;
const zephyr_agent_1 = require("zephyr-agent");
/**
 * Emits the zephyr-manifest.json file during the build process This ensures the manifest
 * is available for local development and production Includes both federated dependencies
 * and environment variables
 */
function setupManifestEmission(pluginOptions, compiler) {
    const { pluginName, zephyr_engine } = pluginOptions;
    const { RawSource } = compiler.webpack.sources;
    compiler.hooks.thisCompilation.tap(pluginName, (compilation) => {
        compilation.hooks.processAssets.tapPromise({
            name: `${pluginName}:EmitManifest`,
            stage: compiler.webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONAL,
        }, async () => {
            // Always emit manifest, even without federated dependencies
            // This ensures environment variables are always available
            const dependencies = zephyr_engine.federated_dependencies || [];
            // Convert to JSON with environment variables included
            const manifestContent = (0, zephyr_agent_1.createManifestContent)(dependencies, true);
            // Emit the asset
            compilation.emitAsset('zephyr-manifest.json', new RawSource(manifestContent));
            zephyr_agent_1.ze_log.manifest('[Zephyr Manifest] Emitted with:', {
                dependencies: dependencies.length,
                hasEnvVars: manifestContent.includes('zeVars'),
            });
        });
    });
}
//# sourceMappingURL=ze-emit-manifest.js.map