"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.zeUploadSnapshot = zeUploadSnapshot;
const crypto_1 = require("crypto");
const errors_1 = require("../errors");
const upload_snapshot_1 = require("../http/upload-snapshot");
const picocolor_1 = require("../logging/picocolor");
async function zeUploadSnapshot(zephyr_engine, { snapshot }) {
    var _a;
    const zeStart = Date.now();
    const application_uid = zephyr_engine.application_uid;
    const logger = await zephyr_engine.logger;
    const buildEnv = zephyr_engine.env.isCI ? 'ci' : 'local';
    // Collect env vars for hash generation (needed by API)
    // but don't store them in snapshot (they're in the manifest asset)
    const envs = process.env;
    const ze_envs = {};
    for (const [key, value] of Object.entries(envs)) {
        if (key.startsWith('ZE_PUBLIC_') && typeof value === 'string')
            ze_envs[key] = value;
    }
    // Generate hash for environment variables with application scope
    const zeVarsEntries = Object.entries(ze_envs);
    if (zeVarsEntries.length > 0) {
        const sortedVariables = zeVarsEntries
            .map(([key, value]) => `${key}=${value}`)
            .sort()
            .join('\n');
        const canonicalString = `${application_uid}\n${sortedVariables}`;
        const hash = (0, crypto_1.createHash)('sha256');
        hash.update(canonicalString, 'utf-8');
        snapshot.ze_envs_hash = hash.digest('hex');
        // Store env vars and hash temporarily on engine for API to use
        // (not in snapshot, just for transmission to API)
        zephyr_engine.ze_env_vars = ze_envs;
        zephyr_engine.ze_env_vars_hash = snapshot.ze_envs_hash;
    }
    // Note: snapshot.ze_envs is no longer set - env vars are in manifest asset
    const edgeTodo = await (0, upload_snapshot_1.uploadSnapshot)({
        body: snapshot,
        application_uid,
    });
    const versionUrl = (_a = edgeTodo === null || edgeTodo === void 0 ? void 0 : edgeTodo.urls) === null || _a === void 0 ? void 0 : _a.version;
    if (!versionUrl) {
        logger({
            level: 'error',
            action: 'snapshot:upload:failed',
            message: `failed uploading of ${buildEnv} snapshot to zephyr`,
        });
        throw new errors_1.ZephyrError(errors_1.ZeErrors.ERR_SNAPSHOT_UPLOADS_NO_RESULTS);
    }
    logger({
        level: 'info',
        action: 'snapshot:upload:done',
        message: `Uploaded ${(0, picocolor_1.green)(buildEnv)} snapshot in ${(0, picocolor_1.yellow)(`${Date.now() - zeStart}`)}ms`,
    });
    return versionUrl;
}
//# sourceMappingURL=ze-upload-snapshot.js.map